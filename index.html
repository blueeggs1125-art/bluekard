<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" sizes="16x16" href="icon/16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon/32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="icon/48x48.png">
    <link rel="icon" type="image/png" sizes="64x64" href="icon/64x64.png">
    <link rel="icon" type="image/png" sizes="128x128" href="icon/128x128.png">
    <link rel="icon" type="image/png" sizes="256x256" href="icon/256x256.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon/512x512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon/180x180.png">
    <link rel="manifest" href="site.webmanifest">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>FUCK 1939</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 24px;
        }
        
        .selector-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            background-color: white;
            aspect-ratio: 2/3; 
        }
        
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            -webkit-touch-callout: default; /* 允许iOS上的长按菜单 */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .image-item .image-name {
            padding: 5px;
            font-size: 11px;
            text-align: center;
            background-color: rgba(0,0,0,0.8);
            color: white;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .no-images {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
            grid-column: 1 / -1;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            grid-column: 1 / -1;
        }
        
        /* 添加导航链接样式 */
        .nav-link {
            display: block;
            text-align: center;
            margin: 15px 0;
            color: #1e90ff;
            text-decoration: none;
            font-weight: bold;
        }
        
        .nav-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .image-container {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 8px;
            }
            
            h1 {
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .image-container {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 5px;
            }
            
            .image-item .image-name {
                font-size: 8px;
                padding: 2px;
            }
        }
    </style>
</head>
<body>
    <a href="https://space.bilibili.com/596035099" target="_blank" style="display: block; text-align: center; margin-top: 20px; color: #1e90ff; text-decoration: none;">blueeggs</a>
    <div class="container">
        <h1>KARDS素材库</h1>
         <h2>最后提交时间：2525/8/28 12:21</h2>
        <!-- 添加跳转到音效页面的链接 -->
        <a href="suck.html" class="nav-link">前往音效库</a>
        
        <div class="selector-group">
            <label for="search-input">搜索图片:</label>
            <input type="text" id="search-input" placeholder="输入关键词搜索图片...">
        </div>
        
        <div class="selector-group">
            <label for="country-select">选择国家/类型:</label>
            <select id="country-select">
                <option value="">请选择...</option>
                <option value="苏联">苏联</option>
                <option value="美国">美国</option>
                <option value="德国">德国</option>
                <option value="日本">日本</option>
                <option value="英国">英国</option>
                <option value="波兰">波兰</option>
                <option value="法国">法国</option>
                <option value="意大利">意大利</option>
                <option value="芬兰">芬兰</option>
                <option value="总部">总部</option>
                <option value="卡背">卡背</option>
            </select>
        </div>
        
        <div class="selector-group" id="subtype-group" style="display: none;">
            <label for="subtype-select">选择卡牌类型:</label>
            <select id="subtype-select">
                <option value="">请选择...</option>
            </select>
        </div>
        
        <div id="image-display">
            <div class="no-images">请先选择国家/类型或搜索关键词</div>
        </div>
    </div>

    <script src="js/image.js"></script>
    
<script>
    // 添加一个新函数用于处理包含中文的图片路径
    function encodeImagePath(path) {
        // 将路径中的每个部分进行编码，但保持分隔符不变
        return path.split('/').map(part => encodeURIComponent(part)).join('/');
    }

    // 根据关键词搜索图片
    function searchImagesByKeyword(keyword) {
        return fetch('data/newimages.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('newimages.json 网络响应错误');
                }
                return response.json();
            })
            .then(imagesData => {
                const results = [];
                const searchKeyword = keyword.trim().toLowerCase();
                const addedPaths = new Set(); // 用于避免重复添加
                
                // 遍历 newimages.json 中的图片数据
                for (const country in imagesData) {
                    if (!imagesData.hasOwnProperty(country)) continue;
                    
                    const countryData = imagesData[country];
                    
                    // 如果国家数据是数组格式（总部、卡背等没有子类型）
                    if (Array.isArray(countryData)) {
                        countryData.forEach(imagePath => {
                            const fileName = imagePath.split('/').pop();
                            // 只检查文件名是否匹配关键词（不区分大小写）
                            if (fileName.toLowerCase().includes(searchKeyword)) {
                                // 避免重复添加
                                if (!addedPaths.has(imagePath)) {
                                    addedPaths.add(imagePath);
                                    results.push({
                                        path: imagePath,
                                        name: fileName,
                                        description: ''
                                    });
                                }
                            }
                        });
                    } 
                    // 如果国家数据是对象格式（有子类型：金卡、银卡等）
                    else {
                        for (const subtype in countryData) {
                            if (!countryData.hasOwnProperty(subtype)) continue;
                            
                            countryData[subtype].forEach(imagePath => {
                                const fileName = imagePath.split('/').pop();
                                // 只检查文件名是否匹配关键词（不区分大小写）
                                if (fileName.toLowerCase().includes(searchKeyword)) {
                                    // 避免重复添加
                                    if (!addedPaths.has(imagePath)) {
                                        addedPaths.add(imagePath);
                                        results.push({
                                            path: imagePath,
                                            name: fileName,
                                            description: ''
                                        });
                                    }
                                }
                            });
                        }
                    }
                }
                
                return results;
            })
            .catch(error => {
                console.error('搜索图片失败:', error);
                return [];
            });
    }

    const countries = {
        '苏联': { name: '苏联', hasSubtypes: true },
        '美国': { name: '美国', hasSubtypes: true },
        '德国': { name: '德国', hasSubtypes: true },
        '日本': { name: '日本', hasSubtypes: true },
        '英国': { name: '英国', hasSubtypes: true },
        '波兰': { name: '波兰', hasSubtypes: true },
        '法国': { name: '法国', hasSubtypes: true },
        '意大利': { name: '意大利', hasSubtypes: true },
        '芬兰': { name: '芬兰', hasSubtypes: true },
        '总部': { name: '总部', hasSubtypes: false },
        '卡背': { name: '卡背', hasSubtypes: false }
    };
    
    const subtypes = {
        '金卡': '金卡',
        '银卡': '银卡',
        '铜卡': '铜卡',
        '铁卡': '铁卡'
    };
    
    const noGoldCountries = ['波兰', '法国', '意大利', '芬兰'];
    
    const countrySelect = document.getElementById('country-select');
    const subtypeGroup = document.getElementById('subtype-group');
    const subtypeSelect = document.getElementById('subtype-select');
    const imageDisplay = document.getElementById('image-display');
    const searchInput = document.getElementById('search-input');
    
    // 添加搜索功能
    searchInput.addEventListener('input', function() {
        const keyword = this.value.trim();
        if (keyword.length > 0) {
            searchImages(keyword);
        } else if (countrySelect.value) {
            // 如果搜索框为空但已选择国家，则显示该国家的图片
            if (countries[countrySelect.value].hasSubtypes && subtypeSelect.value) {
                displayImages(countrySelect.value, subtypeSelect.value);
            } else if (!countries[countrySelect.value].hasSubtypes) {
                displayImages(countrySelect.value);
            } else {
                imageDisplay.innerHTML = '<div class="no-images">请选择卡牌类型</div>';
            }
        } else {
            imageDisplay.innerHTML = '<div class="no-images">请先选择国家/类型或搜索关键词</div>';
        }
    });
    
    countrySelect.addEventListener('change', function() {
        const country = this.value;
        if (!country) {
            subtypeGroup.style.display = 'none';
            imageDisplay.innerHTML = '<div class="no-images">请先选择国家/类型</div>';
            return;
        }
        
        const countryConfig = countries[country];
        if (countryConfig.hasSubtypes) {
            subtypeGroup.style.display = 'block';
            updateSubtypeOptions(country);
            imageDisplay.innerHTML = '<div class="no-images">请选择卡牌类型</div>';
        } else {
            subtypeGroup.style.display = 'none';
            displayImages(country);
        }
    });
    
    subtypeSelect.addEventListener('change', function() {
        const country = countrySelect.value;
        const subtype = this.value;
        if (country && subtype) {
            displayImages(country, subtype);
        } else {
            imageDisplay.innerHTML = '<div class="no-images">请选择卡牌类型</div>';
        }
    });
    
    function updateSubtypeOptions(country) {
        subtypeSelect.innerHTML = '<option value="">请选择...</option>';
        
        for (const [key, name] of Object.entries(subtypes)) {
            if (key === '金卡' && noGoldCountries.includes(country)) {
                continue;
            }
            const option = document.createElement('option');
            option.value = key;
            option.textContent = name;
            subtypeSelect.appendChild(option);
        }
    }
    
    // 显示特定国家和类型的图片
    async function displayImages(country, subtype = null) {
        imageDisplay.innerHTML = '<div class="loading">加载中...</div>';
        
        try {
            const response = await fetch('data/newimages.json');
            if (!response.ok) {
                throw new Error('newimages.json 网络响应错误');
            }
            const imagesData = await response.json();
            
            let filteredImages = [];
            
            // 根据国家和子类型筛选图片
            if (imagesData[country]) {
                if (countries[country].hasSubtypes && subtype && imagesData[country][subtype]) {
                    // 有子类型的情况
                    filteredImages = imagesData[country][subtype];
                } else if (!countries[country].hasSubtypes) {
                    // 没有子类型的情况（总部、卡背）
                    filteredImages = imagesData[country];
                }
            }
            
            if (filteredImages.length === 0) {
                imageDisplay.innerHTML = '<div class="no-images">暂无图片</div>';
                return;
            }
            
            renderImages(filteredImages);
            
        } catch (error) {
            console.error('加载图片出错:', error);
            imageDisplay.innerHTML = '<div class="no-images">加载图片失败</div>';
        }
    }
    
    // 搜索图片功能
    async function searchImages(keyword) {
        imageDisplay.innerHTML = '<div class="loading">搜索中...</div>';
        
        try {
            const searchResults = await searchImagesByKeyword(keyword);
            
            if (searchResults.length === 0) {
                imageDisplay.innerHTML = '<div class="no-images">未找到匹配的图片</div>';
                return;
            }
            
            renderImages(searchResults);
        } catch (error) {
            console.error('搜索图片出错:', error);
            imageDisplay.innerHTML = '<div class="no-images">搜索图片失败</div>';
        }
    }
    
    // 渲染图片列表
    function renderImages(images) {
        let html = '<div class="image-container">';
        images.forEach(image => {
            // 处理搜索结果和普通图片路径的不同
            const imagePath = typeof image === 'object' ? image.path : image;
            // 对整个路径进行编码以支持中文
            const encodedImagePath = encodeImagePath(imagePath);
            const fileName = imagePath.split('/').pop();
            const displayName = typeof image === 'object' ? (image.name || fileName) : fileName;
            
            // 对文件名进行编码用于下载
            const encodedFileName = encodeURIComponent(fileName);
            
            html += `
                <div class="image-item">
                    <img src="${encodedImagePath}" alt="${displayName}" 
                         data-url="${encodedImagePath}"
                         data-filename="${encodedFileName}"
                         onload="this.parentNode.classList.add('loaded')">
                </div>
            `;
        });
        html += '</div>';
        
        imageDisplay.innerHTML = html;
        
        // 为所有图片添加触摸事件
        document.querySelectorAll('.image-item img').forEach(img => {
            new ImageTouchHandler(img);
        });
    }
    
    // 图片触摸处理类
    class ImageTouchHandler {
        constructor(element) {
            this.element = element;
            this.touchStartTime = 0;
            this.touchTimer = null;
            this.touchHandled = false;
            
            this.init();
        }
        
        init() {
            // 添加触摸事件监听器
            this.element.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
            this.element.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: false });
            this.element.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
            this.element.addEventListener('contextmenu', (e) => this.handleContextMenu(e));
        }
        
        handleTouchStart(event) {
            this.touchStartTime = Date.now();
            this.touchHandled = false;
            clearTimeout(this.touchTimer);
            
            // 长按800ms后触发下载
            this.touchTimer = setTimeout(() => {
                if (!this.touchHandled) {
                    this.downloadImage();
                    this.touchHandled = true;
                }
            }, 800);
            
            // 阻止默认行为和事件冒泡
            // 注意：不要完全阻止，否则可能影响长按菜单
            // event.preventDefault();
            // event.stopPropagation();
        }
        
        handleTouchMove(event) {
            // 如果用户移动手指，取消长按下载
            clearTimeout(this.touchTimer);
            this.touchHandled = true;
        }
        
        handleTouchEnd(event) {
            // 如果用户提前结束触摸，取消长按下载
            clearTimeout(this.touchTimer);
            this.touchHandled = true;
        }
        
        handleContextMenu(event) {
            // 右键菜单触发下载
            event.preventDefault();
            this.downloadImage();
        }
        
        downloadImage() {
            const url = this.element.dataset.url;
            const filename = decodeURIComponent(this.element.dataset.filename);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    // 为了兼容性，也保留全局函数
    function downloadImage(event, url, filename) {
        event.preventDefault();
        event.stopPropagation();
        
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>